<!DOCTYPE html>
<html>
<head>
    <title>SMART Container Example</title>
    <link rel='stylesheet' href='styles.css' type='text/css' />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="../framework/smart/scripts/jschannel.js"></script>
    <script src="http://sandbox-v06.smartplatforms.org/static/smart_common/resources/smart-api-container.js"></script>
</head>
<body>
    <script>
    var simple_context = { 
      record: {
        full_name: 'Anonymous',
        id: '1000000012'
      },
      user: {
        full_name: 'Logged.In.User',
        id: 'some_user_id'
      }
    };

    var got_statins_manifest = {
      "name" : "Got Statins?",
      "description" : "Determines whether patient is taking a statin",
      "author" : "Josh Mandel, Children's Hospital Boston",
      "id" : "got-statins@apps.smartplatforms.org",
      "version" : ".1a",
      "mode" : "ui",
      "scope" : "record",
      "index" : "http://sample-apps-v06.smartplatforms.org/framework/got_statins/index.html",
      "icon" :  "http://sample-apps-v06.smartplatforms.org/framework/got_statins/icon.png"
    };

    var med_list_manifest = {
      "name" : "Med List",
      "description" : "Display medications in a table or timeline view",
      "author" : "Josh Mandel, Children's Hospital Boston",
      "id" : "med-list@apps.smartplatforms.org",
      "version" : ".1a",
      "mode" : "ui",	
      "scope": "record",
      "icon" : "http://sample-apps-v06.smartplatforms.org/framework/med_list/icon.png",
      "index": "http://sample-apps-v06.smartplatforms.org/framework/med_list/index.html",
    }

    var all_manifests = [got_statins_manifest, med_list_manifest];
    var manifest_hash = {};
    $.each(all_manifests, function(i,m) {
      manifest_hash[m.id] = m;
    });

    SMART = new SMART_CONNECT_HOST();

    SMART.get_credentials = function (app_instance, callback){

      /* Here's where we'd AJAX out to ask for tokens scoped for:
           * app_instance.manifest.id
           * app_instance.context.user.id
           * app_instance.context.record.id
       */

      var credentials = {
        api_base: "http://sandbox-api-v06.smartplatforms.org",
        rest_token:"", 
        rest_secret: "",
        oauth_header: ""
      }; 

      callback(credentials);
    };

    SMART.get_iframe = function (app_instance, callback){
        $("iframe").remove(); // clear old apps

        var frame_id = "app_iframe_"+app_instance.uuid;
        var iframe_str = "<iframe src='about:blank;' id='"+frame_id+"'></iframe>";
        var iframe = $(iframe_str);
        $("body").append(iframe);
        callback(iframe[0]);
    };

    SMART.handle_api = function(app_instance, api_call, callback_success, callback_error)
    {
        var success = function(data, status_code, xhr) {
                var ct = xhr.getResponseHeader("Content-Type") || "unknown";
                callback_success({
                    contentType: "application/rdf+xml",  
                    data: data});
            };

          // Return a fake medication list...
          if (api_call.method=="GET" && api_call.func.match(/^.*\/medications\/$/)) {
                     $.ajax({type: 'get', url: 'sample_meds.xml', dataType: 'text'})
                        .success(success).error(error);
          } else {
            alert("Function " + api_call.func + " not implemented yet.");
          }
    };

    var clicked = function(app_id) {
      SMART.launch_app(manifest_hash[app_id], simple_context);
    };
    </script>
    <div id="app_selector">
        <input type="submit" value="Got Statins?" onclick="javascript:clicked('got-statins@apps.smartplatforms.org');"/>
        <input type="submit" value="Med List" onclick="javascript:clicked('med-list@apps.smartplatforms.org');"/>
    </div>
</body>
</html>
